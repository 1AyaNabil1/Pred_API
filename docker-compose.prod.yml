version: "3.8"

# Production Docker Compose configuration
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  mlflow:
    restart: always
    environment:
      - MLFLOW_BACKEND_STORE_URI=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=s3://${S3_BUCKET}/mlartifacts
      # Add AWS credentials if using S3
      # - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      # - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      # - AWS_DEFAULT_REGION=${AWS_REGION}
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      --default-artifact-root s3://${S3_BUCKET}/mlartifacts

  backend:
    restart: always
    volumes:
      - mlartifacts-data:/app/mlartifacts
      - mlruns-data:/app/mlruns
    environment:
      - LOG_LEVEL=WARNING
      - MLFLOW_BASE_URL=http://mlflow:5000
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - API_KEY=${API_KEY}

  frontend:
    restart: always
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL}

  # Optional: PostgreSQL for production MLflow backend
  postgres:
    image: postgres:15-alpine
    container_name: mlflow-postgres
    environment:
      - POSTGRES_DB=${DB_NAME:-mlflow}
      - POSTGRES_USER=${DB_USER:-mlflow}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - pred-api-network
    restart: always

volumes:
  postgres-data:
  mlflow-data:
  mlartifacts-data:
  mlruns-data:
